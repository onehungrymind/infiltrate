<div class="pipeline-container">
  <!-- Pipeline Header -->
  <div class="pipeline-header">
    <div class="header-left">
      <h1 class="page-title">Learning Paths</h1>
      @if (selectedLearningPath()) {
        <span class="selected-path-name">{{ selectedLearningPath()?.name }}</span>
      }
    </div>
    <div class="header-right">
      @if (isRunning()) {
        <div class="pipeline-status">
          <app-pipeline-progress-indicator
            [stages]="pipelineStages"
            [currentStage]="currentStage"
            [completedStages]="completedStages"
            [errorStage]="errorStage"
          ></app-pipeline-progress-indicator>
          @if (currentProgress()) {
            <span class="progress-text">{{ currentProgress() }}</span>
          }
        </div>
      }
      <button
        class="run-pipeline-btn"
        [disabled]="!canRunPipeline()"
        (click)="runFullPipeline()"
      >
        @if (isRunning()) {
          <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
          <span>Building...</span>
        } @else {
          <mat-icon>auto_awesome</mat-icon>
          <span>Build Learning Path</span>
        }
      </button>
    </div>
  </div>

  <!-- Columns Container -->
  <div class="columns-container">
    <div class="columns-inner">
    <!-- Column 1: Learning Paths -->
    <app-pipeline-column
      title="Learning Paths"
      actionLabel="New Path"
      actionIcon="add"
      [items]="learningPathsSignal"
      [loading]="alwaysFalse"
      [enabled]="alwaysTrue"
      emptyMessage="No learning paths"
      emptyIcon="school"
      (action)="createNewLearningPath()"
    >
      @if (learningPathsError()) {
        <div class="error-state">
          <mat-icon>error_outline</mat-icon>
          <span>{{ learningPathsError() }}</span>
        </div>
      } @else if (!learningPathsLoaded()) {
        <div class="loading-state">
          <mat-spinner diameter="24"></mat-spinner>
        </div>
      } @else {
        <app-learning-paths-list
          [learningPaths]="learningPaths()"
          [selectedLearningPath]="selectedLearningPath()"
          [compact]="true"
          (selected)="selectLearningPath($event)"
          (deleted)="deleteLearningPath($event)"
          (edited)="editLearningPath($event)"
        ></app-learning-paths-list>
      }
    </app-pipeline-column>

    <!-- Learning Path Editor Panel -->
    <div class="editor-panel" [class.open]="isEditingPath()">
      <div class="editor-panel-inner">
        <div class="editor-header">
          <h3>{{ editingPath() ? 'Edit Learning Path' : 'New Learning Path' }}</h3>
          <button class="close-btn" (click)="closePathEditor()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="editor-content">
          @if (isEditingPath()) {
            <app-learning-path-detail
              [learningPath]="editingPath()"
              (saved)="saveLearningPath($event)"
              (cancelled)="closePathEditor()"
            ></app-learning-path-detail>
          }
        </div>
      </div>
    </div>

    <!-- Column 2: Concepts -->
    <app-pipeline-column
      title="Concepts"
      actionLabel="Generate"
      actionIcon="auto_awesome"
      [items]="conceptsSignal"
      [loading]="generatingConcepts"
      [enabled]="canGenerateConcepts"
      [showSecondaryAction]="true"
      emptyMessage="Select a path to see concepts"
      emptyIcon="lightbulb"
      (action)="generateConcepts()"
      (secondaryAction)="createNewConcept()"
    >
      @for (concept of concepts(); track concept.id) {
        <div
          class="item-card"
          [class.selected]="selectedConcept()?.id === concept.id"
          (click)="selectConcept(concept)"
        >
          <div class="item-title">{{ concept.name }}</div>
          @if (concept.description) {
            <div class="item-description">{{ concept.description }}</div>
          }
          <div class="item-meta">
            <span class="difficulty-badge" [class]="'difficulty-' + concept.difficulty">
              {{ concept.difficulty }}
            </span>
            <button class="edit-btn" (click)="editConcept(concept); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
        </div>
      }
    </app-pipeline-column>

    <!-- Concept Editor Panel -->
    <div class="editor-panel" [class.open]="isEditingConcept()">
      <div class="editor-panel-inner">
        <div class="editor-header">
          <h3>{{ editingConcept() ? 'Edit Concept' : 'New Concept' }}</h3>
          <button class="close-btn" (click)="closeConceptEditor()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="editor-content">
          @if (isEditingConcept()) {
            <app-concept-detail
              [concept]="editingConcept()"
              [pathId]="selectedLearningPath()?.id || null"
              (saved)="saveConcept($event)"
              (cancelled)="closeConceptEditor()"
            ></app-concept-detail>
          }
        </div>
      </div>
    </div>

    <!-- Column 3: Sub-concepts -->
    <app-pipeline-column
      title="Sub-concepts"
      actionLabel="Decompose"
      actionIcon="account_tree"
      [items]="subConceptsSignal"
      [loading]="decomposing"
      [enabled]="canDecompose"
      [showSecondaryAction]="true"
      emptyMessage="Select a concept to see sub-concepts"
      emptyIcon="category"
      (action)="decomposeConcept()"
      (secondaryAction)="createNewSubConcept()"
    >
      @for (subConcept of subConcepts(); track subConcept.id) {
        <div
          class="item-card"
          [class.selected]="selectedSubConcept()?.id === subConcept.id"
          (click)="selectSubConcept(subConcept)"
        >
          <div class="item-title">{{ subConcept.name }}</div>
          @if (subConcept.description) {
            <div class="item-description">{{ subConcept.description }}</div>
          }
          <div class="item-meta">
            <button class="edit-btn" (click)="editSubConcept(subConcept); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
        </div>
      }
    </app-pipeline-column>

    <!-- Sub-concept Editor Panel -->
    <div class="editor-panel" [class.open]="isEditingSubConcept()">
      <div class="editor-panel-inner">
        <div class="editor-header">
          <h3>{{ editingSubConcept() ? 'Edit Sub-concept' : 'New Sub-concept' }}</h3>
          <button class="close-btn" (click)="closeSubConceptEditor()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="editor-content">
          @if (isEditingSubConcept()) {
            <app-sub-concept-detail
              [subConcept]="editingSubConcept()"
              [conceptId]="selectedConcept()?.id || null"
              (saved)="saveSubConcept($event)"
              (cancelled)="closeSubConceptEditor()"
            ></app-sub-concept-detail>
          }
        </div>
      </div>
    </div>

    <!-- Column 4: Knowledge Units -->
    <app-pipeline-column
      title="Knowledge Units"
      actionLabel="Generate"
      actionIcon="auto_awesome"
      [items]="structuredKnowledgeUnitsSignal"
      [loading]="generatingKU"
      [enabled]="canGenerateKU"
      [showSecondaryAction]="true"
      emptyMessage="Select a sub-concept to see KUs"
      emptyIcon="psychology"
      (action)="generateStructuredKU()"
      (secondaryAction)="createNewKnowledgeUnit()"
    >
      @for (unit of structuredKnowledgeUnits(); track unit.id) {
        <div class="item-card" (click)="editKnowledgeUnit(unit)">
          <div class="item-title">{{ unit.concept }}</div>
          @if (unit.status) {
            <div class="item-meta">
              <span class="unit-type structured">structured</span>
              <span class="unit-status" [class]="'status-' + unit.status">{{ unit.status }}</span>
            </div>
          }
        </div>
      }
    </app-pipeline-column>

    <!-- Knowledge Unit Editor Panel -->
    <div class="editor-panel" [class.open]="isEditingKnowledgeUnit()">
      <div class="editor-panel-inner">
        <div class="editor-header">
          <h3>{{ editingKnowledgeUnit() ? 'Edit Knowledge Unit' : 'New Knowledge Unit' }}</h3>
          <button class="close-btn" (click)="closeKnowledgeUnitEditor()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="editor-content">
          @if (isEditingKnowledgeUnit()) {
            <app-knowledge-unit-detail
              [knowledgeUnit]="editingKnowledgeUnit()"
              [pathId]="selectedLearningPath()?.id || null"
              (saved)="saveKnowledgeUnit($event)"
              (cancelled)="closeKnowledgeUnitEditor()"
            ></app-knowledge-unit-detail>
          }
        </div>
      </div>
    </div>
    </div>
  </div>
</div>
