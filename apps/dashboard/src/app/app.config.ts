import { provideHttpClient, withInterceptors } from '@angular/common/http';
import {
  ApplicationConfig,
  ErrorHandler,
  isDevMode,
} from '@angular/core';
import { provideSignalFormsConfig } from '@angular/forms/signals';
import { provideAnimations } from '@angular/platform-browser/animations';
import { provideRouter } from '@angular/router';
import { API_URL, authInterceptor, errorInterceptor, GlobalErrorHandler } from '@kasita/core-data';
import {
  challengesFeature,
  checkEnrollment,
  createChallenge,
  createDataSource,
  createKnowledgeUnit,
  createLearningPath,
  createConcept,
  createProject,
  createRawContent,
  createSubmission,
  createUser,
  createUserProgress,
  dataSourcesFeature,
  deleteChallenge,
  deleteDataSource,
  deleteKnowledgeUnit,
  deleteLearningPath,
  deleteConcept,
  deleteProject,
  deleteRawContent,
  deleteSubmission,
  deleteUser,
  deleteUserProgress,
  enroll,
  enrollmentsFeature,
  knowledgeUnitsFeature,
  learningPathsFeature,
  linkConcept,
  loadChallenge,
  // Challenges Effects
  loadChallenges,
  loadChallengesByUnit,
  loadDataSource,
  // Data Sources Effects
  loadDataSources,
  // Enrollments Effects
  loadEnrollments,
  loadEnrollmentsByPath,
  loadEnrollmentsByUser,
  loadFeedback,
  loadKnowledgeUnit,
  // Knowledge Units Effects
  loadKnowledgeUnits,
  loadKnowledgeUnitsByPath,
  loadKnowledgeUnitsBySubConcept,
  loadLeaderboard,
  loadLearningPath,
  // Learning Paths Effects
  loadLearningPaths,
  loadMentorSubmissions,
  loadConcept,
  // Concepts Effects
  loadConcepts,
  loadConceptsByPath,
  loadProject,
  // Projects Effects
  loadProjects,
  loadProjectsByPath,
  // Raw Content Effects
  loadRawContent,
  loadRawContentByPath,
  loadRawContentItem,
  loadSubmission,
  // Submissions Effects
  loadSubmissions,
  loadSubmissionsByPath,
  loadSubmissionsByUnit,
  loadSubmissionsByUser,
  loadUser,
  // User Progress Effects
  loadUserProgress,
  loadUserProgressItem,
  // Users Effects
  loadUsers,
  conceptsFeature,
  projectsFeature,
  rawContentFeature,
  requestAiFeedback,
  submissionsFeature,
  submitForReview,
  submitMentorFeedback,
  unenroll,
  unlinkConcept,
  updateChallenge,
  updateDataSource,
  updateEnrollment,
  updateKnowledgeUnit,
  updateLearningPath,
  updateConcept,
  updateProject,
  updateRawContent,
  updateSubmission,
  updateUser,
  updateUserProgress,
  userProgressFeature,
  usersFeature,
  // Gymnasium
  gymnasiumFeature,
  loadSessions,
  loadPublicSessions,
  loadSession,
  loadSessionBySlug,
  renderSession,
  renderSessionBySlug,
  createGymnasiumSession,
  updateGymnasiumSession,
  deleteGymnasiumSession,
  publishSession,
  unpublishSession,
  generateSession,
  loadTemplates,
  loadDefaultTemplate,
  // SubConcepts
  subConceptsFeature,
  loadSubConcepts,
  loadSubConcept,
  loadSubConceptsByConcept,
  createSubConcept,
  updateSubConcept,
  deleteSubConcept,
  decomposeConcept,
  generateStructuredKU,
  addDecoration,
  removeDecoration,
  // BuildJobs (BullMQ Pipeline)
  buildJobsFeature,
  createBuildJob,
  loadJobsByPath,
  loadActiveJob,
  loadJobProgress,
  cancelJob,
  subscribeToJobEventsAfterCreate,
  subscribeToActiveJobOnLoad,
  subscribeToJobEvents,
  loadProgressOnJobComplete,
} from '@kasita/core-state';
import { provideEffects } from '@ngrx/effects';
import { provideStore } from '@ngrx/store';
import { provideStoreDevtools } from '@ngrx/store-devtools';

import { environment } from '../environments/environment';
import { appRoutes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [
    provideAnimations(), // Enable Angular animations (deprecated but still required for @ animations)
    provideRouter(appRoutes),
    provideHttpClient(withInterceptors([errorInterceptor, authInterceptor])),
    provideSignalFormsConfig({}),
    { provide: API_URL, useValue: environment.apiUrl },
    { provide: ErrorHandler, useClass: GlobalErrorHandler },
    // NgRx Store Configuration
    provideStore({
      learningPaths: learningPathsFeature.reducer,
      knowledgeUnits: knowledgeUnitsFeature.reducer,
      concepts: conceptsFeature.reducer,
      rawContent: rawContentFeature.reducer,
      userProgress: userProgressFeature.reducer,
      dataSources: dataSourcesFeature.reducer,
      users: usersFeature.reducer,
      submissions: submissionsFeature.reducer,
      challenges: challengesFeature.reducer,
      projects: projectsFeature.reducer,
      enrollments: enrollmentsFeature.reducer,
      gymnasium: gymnasiumFeature.reducer,
      subConcepts: subConceptsFeature.reducer,
      buildJobs: buildJobsFeature.reducer,
    }),
    provideEffects({
      // Learning Paths
      loadLearningPaths,
      loadLearningPath,
      createLearningPath,
      updateLearningPath,
      deleteLearningPath,
      // Knowledge Units
      loadKnowledgeUnits,
      loadKnowledgeUnit,
      loadKnowledgeUnitsByPath,
      loadKnowledgeUnitsBySubConcept,
      createKnowledgeUnit,
      updateKnowledgeUnit,
      deleteKnowledgeUnit,
      // Concepts
      loadConcepts,
      loadConcept,
      loadConceptsByPath,
      createConcept,
      updateConcept,
      deleteConcept,
      // Raw Content
      loadRawContent,
      loadRawContentItem,
      loadRawContentByPath,
      createRawContent,
      updateRawContent,
      deleteRawContent,
      // User Progress
      loadUserProgress,
      loadUserProgressItem,
      createUserProgress,
      updateUserProgress,
      deleteUserProgress,
      // Data Sources
      loadDataSources,
      loadDataSource,
      createDataSource,
      updateDataSource,
      deleteDataSource,
      // Users
      loadUsers,
      loadUser,
      createUser,
      updateUser,
      deleteUser,
      // Submissions
      loadSubmissions,
      loadSubmission,
      loadSubmissionsByUser,
      loadSubmissionsByUnit,
      loadSubmissionsByPath,
      createSubmission,
      updateSubmission,
      deleteSubmission,
      submitForReview,
      requestAiFeedback,
      loadFeedback,
      loadMentorSubmissions,
      submitMentorFeedback,
      // Challenges
      loadChallenges,
      loadChallenge,
      loadChallengesByUnit,
      createChallenge,
      updateChallenge,
      deleteChallenge,
      // Projects
      loadProjects,
      loadProject,
      loadProjectsByPath,
      createProject,
      updateProject,
      deleteProject,
      linkConcept,
      unlinkConcept,
      // Enrollments
      loadEnrollments,
      loadEnrollmentsByUser,
      loadEnrollmentsByPath,
      checkEnrollment,
      enroll,
      updateEnrollment,
      unenroll,
      loadLeaderboard,
      // Gymnasium
      loadSessions,
      loadPublicSessions,
      loadSession,
      loadSessionBySlug,
      renderSession,
      renderSessionBySlug,
      createGymnasiumSession,
      updateGymnasiumSession,
      deleteGymnasiumSession,
      publishSession,
      unpublishSession,
      generateSession,
      loadTemplates,
      loadDefaultTemplate,
      // SubConcepts
      loadSubConcepts,
      loadSubConcept,
      loadSubConceptsByConcept,
      createSubConcept,
      updateSubConcept,
      deleteSubConcept,
      decomposeConcept,
      generateStructuredKU,
      addDecoration,
      removeDecoration,
      // BuildJobs (BullMQ Pipeline)
      createBuildJob,
      loadJobsByPath,
      loadActiveJob,
      loadJobProgress,
      cancelJob,
      subscribeToJobEventsAfterCreate,
      subscribeToActiveJobOnLoad,
      subscribeToJobEvents,
      loadProgressOnJobComplete,
    }),
    provideStoreDevtools({
      maxAge: 25,
      logOnly: !isDevMode(),
      autoPause: false, // Disabled to prevent issues with browser devtools open
      trace: false,
      traceLimit: 75,
    }),
  ],
};
