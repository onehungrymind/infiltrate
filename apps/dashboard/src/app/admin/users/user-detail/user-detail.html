<div class="detail-container">
  <div class="detail-header">
    <h1 class="detail-title">{{ originalTitle() | titlecase }}</h1>
  </div>

  <form (submit)="onSubmit($event)" class="detail-form">
    <div class="detail-content">
      <!-- Render fields except role and isActive -->
      @for (fieldDef of filteredFields(); track fieldDef.name) {
        @let field = getField(fieldDef.name);
        @if (field) {
          @let hasError = hasErrors(field);
          @let errorMessages = getErrorMessages(field);
          <div class="form-group" [class.has-error]="hasError">
            <label [for]="fieldDef.name" class="form-label">
              {{ fieldDef.label }}
              @if (fieldDef.required) {
                <span class="required-indicator">*</span>
              }
            </label>
            @if (fieldDef.helpText) {
              <p class="help-text">{{ fieldDef.helpText }}</p>
            }
            @switch (fieldDef.type || 'text') {
              @case ('textarea') {
                <textarea
                  [id]="fieldDef.name"
                  [field]="field!"
                  [placeholder]="fieldDef.placeholder || ''"
                  [rows]="fieldDef.rows || 4"
                  class="form-control"
                  [class.error]="hasError"
                ></textarea>
              }
              @case ('checkbox') {
                <div class="checkbox-wrapper">
                  <input
                    type="checkbox"
                    [id]="fieldDef.name"
                    [field]="field!"
                    class="form-checkbox"
                  />
                  <label [for]="fieldDef.name" class="checkbox-label">
                    {{ fieldDef.placeholder || fieldDef.label }}
                  </label>
                </div>
              }
              @case ('select') {
                <select
                  [id]="fieldDef.name"
                  [field]="field!"
                  class="form-control"
                  [class.error]="hasError"
                >
                  <option value="">-- Select --</option>
                  @for (option of fieldDef.options || []; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
              }
              @default {
                <input
                  [type]="fieldDef.type || 'text'"
                  [id]="fieldDef.name"
                  [field]="field!"
                  [placeholder]="fieldDef.placeholder || ''"
                  class="form-control"
                  [class.error]="hasError"
                />
              }
            }
            @if (hasError) {
              <div class="error-messages">
                @for (error of errorMessages; track error) {
                  <span class="error-message">{{ error }}</span>
                }
              </div>
            }
          </div>
        }
      }

      <!-- Role and Active on same line -->
      <div class="form-row">
        <div class="form-group form-group-half">
          @let roleField = getField('role');
          @if (roleField) {
            @let hasError = hasErrors(roleField);
            @let errorMessages = getErrorMessages(roleField);
            <label for="role" class="form-label">
              Role
            </label>
            <p class="help-text">User role determines access level and permissions</p>
            <select
              id="role"
              [field]="roleField!"
              class="form-control"
              [class.error]="hasError"
            >
              <option value="">-- Select --</option>
              @for (option of roleOptions(); track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
            @if (hasError) {
              <div class="error-messages">
                @for (error of errorMessages; track error) {
                  <span class="error-message">{{ error }}</span>
                }
              </div>
            }
          }
        </div>
        <div class="form-group form-group-half">
          @let isActiveField = getField('isActive');
          @if (isActiveField) {
            @let hasError = hasErrors(isActiveField);
            <label for="isActive" class="form-label">
              Active
            </label>
            <p class="help-text">Whether the user account is active</p>
            <div class="checkbox-wrapper">
              <input
                type="checkbox"
                id="isActive"
                [field]="isActiveField!"
                class="form-checkbox"
                [class.error]="hasError"
              />
            </div>
            @if (hasError) {
              <div class="error-messages">
                @for (error of getErrorMessages(isActiveField); track error) {
                  <span class="error-message">{{ error }}</span>
                }
              </div>
            }
          }
        </div>
      </div>
    </div>

    <div class="detail-actions">
      <button
        type="button"
        class="detail-button detail-button-secondary"
        (click)="onCancel()"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="detail-button detail-button-primary"
        [disabled]="!isFormValid()"
      >
        {{ user?.id ? 'Update' : 'Create' }}
      </button>
    </div>
  </form>

  <!-- Enrollment Management (only for existing users) -->
  @if (user?.id) {
    <app-user-enrollments [user]="user"></app-user-enrollments>
  }
</div>
