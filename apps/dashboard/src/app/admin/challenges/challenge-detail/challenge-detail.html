<div class="detail-container">
  @if (challenge() || true) {
    <div class="detail-header">
      <h1 class="detail-title">{{ originalTitle() | titlecase }}</h1>
      @if (challenge()?.id) {
        <div class="challenge-info">
          <span
            class="difficulty-indicator"
            [style.background-color]="getDifficultyColor(challenge()?.difficulty || 'beginner')"
          >
            {{ challenge()?.difficulty | titlecase }}
          </span>
          @if (challenge()?.isActive === false) {
            <span class="inactive-indicator">Inactive</span>
          }
        </div>
      }
    </div>

    <form (submit)="onSubmit($event)" class="detail-form">
      <div class="detail-content">
        <!-- Unit Selection -->
        <div class="detail-section">
          <label class="detail-section-title">Knowledge Unit *</label>
          <select
            class="unit-select"
            [value]="selectedUnitId()"
            (change)="onUnitChange($any($event.target).value)"
          >
            <option value="">Select a unit...</option>
            @for (unit of units(); track unit.id) {
              <option [value]="unit.id">{{ unit.concept }}</option>
            }
          </select>
        </div>

        <!-- Dynamic Form Fields -->
        <app-dynamic-form
          [metaInfo]="metaInfo"
          [dynamicForm]="dynamicForm"
        />

        <!-- Rubric Builder -->
        <div class="detail-section rubric-section">
          <h3 class="detail-section-title">Rubric Criteria</h3>
          <p class="section-help">Define grading criteria for this challenge</p>

          <!-- Existing Criteria -->
          @if (rubricCriteria().length > 0) {
            <div class="rubric-list">
              @for (criterion of rubricCriteria(); track $index) {
                <div class="rubric-item">
                  <div class="rubric-item-content">
                    <div class="rubric-item-header">
                      <span class="rubric-name">{{ criterion.name }}</span>
                      <span class="rubric-points">{{ criterion.maxPoints }} pts</span>
                    </div>
                    @if (criterion.description) {
                      <p class="rubric-description">{{ criterion.description }}</p>
                    }
                  </div>
                  <button
                    type="button"
                    class="rubric-remove"
                    (click)="removeRubricCriterion($index)"
                    aria-label="Remove criterion"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
              <div class="rubric-total">
                Total: {{ totalRubricPoints() }} points
              </div>
            </div>
          }

          <!-- Add New Criterion -->
          <div class="rubric-add-form">
            <div class="rubric-add-row">
              <input
                type="text"
                class="rubric-input"
                placeholder="Criterion name"
                [value]="newCriterionName()"
                (input)="newCriterionName.set($any($event.target).value)"
              />
              <input
                type="number"
                class="rubric-points-input"
                placeholder="Points"
                min="1"
                max="100"
                [value]="newCriterionMaxPoints()"
                (input)="newCriterionMaxPoints.set(+$any($event.target).value)"
              />
            </div>
            <input
              type="text"
              class="rubric-input rubric-description-input"
              placeholder="Description (optional)"
              [value]="newCriterionDescription()"
              (input)="newCriterionDescription.set($any($event.target).value)"
            />
            <button
              type="button"
              class="rubric-add-button"
              (click)="addRubricCriterion()"
              [disabled]="!newCriterionName().trim() || newCriterionMaxPoints() <= 0"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="add-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Add Criterion
            </button>
          </div>
        </div>
      </div>

      <div class="detail-actions">
        <button
          type="button"
          class="detail-button detail-button-secondary"
          (click)="onCancel()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="detail-button detail-button-primary"
          [disabled]="!isFormValid()"
        >
          {{ challenge()?.id ? 'Update' : 'Create' }}
        </button>
      </div>
    </form>
  } @else {
    <div class="detail-empty">
      <mat-icon class="detail-empty-icon">emoji_events</mat-icon>
      <p class="detail-empty-text">Select a challenge to view details</p>
    </div>
  }
</div>
