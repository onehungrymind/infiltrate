<div class="master-detail-layout">
  <div class="master-panel">
    @if (error()) {
      <div class="error-message">
        <svg class="error-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <span>{{ error() }}</span>
      </div>
    } @else if (!mentorSubmissionsLoaded()) {
      <div class="loading-message">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading submissions...</span>
      </div>
    } @else {
      <app-search-filter-bar
        placeholder="Search submissions..."
        [filterConfigs]="filterConfigs()"
        (searchChange)="onSearchFilterChange($event)"
      ></app-search-filter-bar>
      <div class="list-container">
        <div class="list-header">
          <h1 class="list-title">Mentor Dashboard</h1>
        </div>

        @for (submission of filteredSubmissions(); track submission.id) {
          <div
            class="list-item"
            [class.active]="selectedSubmission()?.id === submission.id"
            (click)="selectSubmission(submission)"
          >
            <div class="list-item-content">
              <div class="list-item-main">
                <div class="list-item-header">
                  @if (submission.projectId) {
                    <svg class="content-type-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44Z" />
                    </svg>
                  } @else {
                    <svg class="content-type-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
                    </svg>
                  }
                  <h3 class="list-item-title">{{ submission.title || 'Untitled Submission' }}</h3>
                </div>
                @if (submission.content && submission.contentType === 'text') {
                  <p class="list-item-meta">{{ submission.content | slice:0:80 }}{{ submission.content.length > 80 ? '...' : '' }}</p>
                }
                <div class="list-item-badges">
                  <span class="status-badge" [style.background-color]="getStatusColor(submission.status)">
                    {{ getStatusLabel(submission.status) }}
                  </span>
                  <span class="type-badge">
                    {{ submission.projectId ? 'Project' : 'Challenge' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        }

        @if (filteredSubmissions().length === 0) {
          <div class="list-empty">
            <svg class="list-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z" />
            </svg>
            <p class="list-empty-text">No submissions to review</p>
          </div>
        }
      </div>
    }
  </div>
  <div class="detail-panel">
    @if (selectedSubmission(); as submission) {
      <div class="detail-container">
        <div class="detail-header">
          <h1 class="detail-title">{{ submission.title || 'Untitled Submission' }}</h1>
        </div>

        <div class="detail-content">
          <div class="detail-meta">
            <span class="meta-item">
              <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
              </svg>
              {{ formatDate(submission.createdAt) }}
            </span>
            <span class="status-badge large" [style.background-color]="getStatusColor(submission.status)">
              {{ getStatusLabel(submission.status) }}
            </span>
          </div>

          @if (submission.contentType === 'text' && submission.content) {
            <div class="detail-section">
              <h3 class="detail-section-title">Content</h3>
              <pre class="detail-code">{{ submission.content }}</pre>
            </div>
          }

          @if (submission.contentType === 'url' && submission.content) {
            <div class="detail-section">
              <h3 class="detail-section-title">Submission URL</h3>
              <a [href]="submission.content" target="_blank" class="detail-link">{{ submission.content }}</a>
            </div>
          }

          @if (submission.contentType === 'file' && submission.fileMetadata) {
            <div class="detail-section">
              <h3 class="detail-section-title">Uploaded File</h3>
              <div class="file-info">
                <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                <span>{{ submission.fileMetadata.originalName }}</span>
                <span class="file-size">({{ submission.fileMetadata.size | number }} bytes)</span>
              </div>
            </div>
          }
        </div>

        <!-- Review Form -->
        <div class="detail-section">
          <h3 class="detail-section-title">Provide Feedback</h3>

          <form [formGroup]="feedbackForm" (ngSubmit)="submitFeedback()" class="review-form">
            <!-- Rubric Breakdown -->
            <div class="rubric-section">
              <label class="form-label">Rubric Scoring</label>
              <div class="rubric-list" formArrayName="rubricBreakdown">
                @for (rubric of rubricArray.controls; track $index; let i = $index) {
                  <div class="rubric-item" [formGroupName]="i">
                    <div class="rubric-header">
                      <span class="rubric-criterion">{{ rubric.get('criterion')?.value }}</span>
                      <div class="rubric-score-input">
                        <input
                          type="number"
                          formControlName="achieved"
                          min="0"
                          max="10"
                          class="score-input"
                          (change)="calculateOverallScore()"
                        />
                        <span class="score-max">/ {{ rubric.get('maximum')?.value }}</span>
                      </div>
                    </div>
                    <input
                      type="text"
                      formControlName="feedback"
                      placeholder="Feedback for this criterion..."
                      class="rubric-feedback-input"
                    />
                  </div>
                }
              </div>
            </div>

            <!-- Overall Score -->
            <div class="form-group">
              <label class="form-label">Overall Score</label>
              <div class="score-display-row">
                <input
                  type="number"
                  formControlName="overallScore"
                  min="0"
                  max="100"
                  class="overall-score-input"
                />
                <div class="score-display" [style.background-color]="getScoreColor(feedbackForm.get('overallScore')?.value)">
                  {{ feedbackForm.get('overallScore')?.value }}%
                </div>
              </div>
            </div>

            <!-- Suggestions -->
            <div class="form-group">
              <label class="form-label">
                Suggestions for Improvement
                <button type="button" class="add-btn" (click)="addSuggestion()">+ Add</button>
              </label>
              <div class="suggestions-list" formArrayName="suggestions">
                @for (suggestion of suggestionsArray.controls; track $index; let i = $index) {
                  <div class="suggestion-row">
                    <input
                      type="text"
                      [formControlName]="i"
                      placeholder="Suggestion {{ i + 1 }}..."
                      class="suggestion-input"
                    />
                    @if (suggestionsArray.length > 1) {
                      <button type="button" class="remove-btn" (click)="removeSuggestion(i)">Ã—</button>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Detailed Feedback -->
            <div class="form-group">
              <label class="form-label">Detailed Feedback</label>
              <textarea
                formControlName="content"
                placeholder="Write your detailed feedback here..."
                class="feedback-textarea"
                rows="6"
              ></textarea>
            </div>

            <!-- Grade (for projects only) -->
            @if (isProjectSubmission()) {
              <div class="form-group grade-section">
                <label class="form-label">Project Grade (Required)</label>
                <div class="grade-options">
                  @for (option of gradeOptions; track option.value) {
                    <label class="grade-option" [class.selected]="feedbackForm.get('grade')?.value === option.value">
                      <input type="radio" formControlName="grade" [value]="option.value" />
                      <span class="grade-dot" [style.background-color]="option.color"></span>
                      <span class="grade-label">{{ option.label }}</span>
                    </label>
                  }
                </div>
              </div>
            }

            <!-- Actions -->
            <div class="detail-actions">
              <button type="button" class="detail-button detail-button-secondary" (click)="clearSelection()">
                Cancel
              </button>
              <button
                type="submit"
                class="detail-button detail-button-primary"
                [disabled]="!feedbackForm.valid || isSubmitting() || (isProjectSubmission() && !feedbackForm.get('grade')?.value)"
              >
                @if (isSubmitting()) {
                  Submitting...
                } @else {
                  Submit Feedback
                }
              </button>
            </div>
          </form>
        </div>
      </div>
    } @else {
      <div class="detail-empty">
        <svg class="detail-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z" />
        </svg>
        <p class="detail-empty-text">Select a submission to review</p>
      </div>
    }
  </div>
</div>
