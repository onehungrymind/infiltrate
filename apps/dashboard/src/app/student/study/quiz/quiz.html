<!-- Setup Mode -->
@if (mode === 'setup') {
  <div class="quiz-container">
    <div class="setup-card">
      <div class="setup-header">
        <div class="setup-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
          </svg>
        </div>
        <h2>Start a Quiz</h2>
        <p>Test your knowledge with multiple choice and true/false questions</p>
      </div>

      <div class="setup-form">
        <div class="form-group">
          <label for="pathSelect">Learning Path</label>
          <select id="pathSelect" [(ngModel)]="selectedPathId" class="form-select">
            <option [ngValue]="null">All Learning Paths</option>
            @for (path of learningPaths; track path.id) {
              <option [value]="path.id">{{ path.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="questionCount">Number of Questions</label>
          <select id="questionCount" [(ngModel)]="questionCount" class="form-select">
            <option [value]="5">5 Questions</option>
            <option [value]="10">10 Questions</option>
            <option [value]="15">15 Questions</option>
            <option [value]="20">20 Questions</option>
          </select>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="showDueOnly" />
            <span class="checkbox-text">Due for review only</span>
          </label>
        </div>

        <div class="available-count">
          @if (!isLoading) {
            <span>{{ availableUnitsCount }} questions available</span>
          } @else {
            <span>Loading...</span>
          }
        </div>

        <button
          class="start-button"
          (click)="startQuiz()"
          [disabled]="isLoading || availableUnitsCount === 0">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
          </svg>
          Start Quiz
        </button>
      </div>
    </div>
  </div>
}

<!-- Quiz Mode -->
@if (mode === 'quiz' && currentQuestion) {
<div class="quiz-container">
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-fill" [style.width.%]="progress"></div>
  </div>
  <div class="progress-text">Question {{ currentIndex + 1 }} of {{ questions.length }}</div>

  <!-- Question Card -->
  <div class="question-card">
    <div class="question-type-badge" [class.multiple-choice]="currentQuestion.type === 'multiple-choice'" [class.true-false]="currentQuestion.type === 'true-false'">
      {{ currentQuestion.type === 'multiple-choice' ? 'Multiple Choice' : 'True / False' }}
    </div>

    <div class="question-concept">{{ currentQuestion.knowledgeUnit.concept }}</div>
    <div class="question-text">{{ currentQuestion.questionText }}</div>

    <div class="options-list">
      @for (option of currentQuestion.options; track $index) {
        <button
          class="option-button"
          [class.selected]="currentQuestion.selectedAnswer === $index"
          [class]="getOptionClass($index)"
          (click)="selectAnswer($index)"
          [disabled]="hasAnswered">
          <span class="option-letter">{{ 'ABCD'[$index] }}</span>
          <span class="option-text">{{ option }}</span>
          @if (hasAnswered && $index === currentQuestion.correctAnswer) {
            <span class="option-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </span>
          }
          @if (hasAnswered && $index === currentQuestion.selectedAnswer && !currentQuestion.isCorrect) {
            <span class="option-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </span>
          }
        </button>
      }
    </div>

    <!-- Feedback -->
    @if (hasAnswered) {
    <div class="feedback">
      <div class="feedback-message" [class.correct]="currentQuestion.isCorrect" [class.incorrect]="!currentQuestion.isCorrect">
        @if (currentQuestion.isCorrect) {
          <span>Correct!</span>
        } @else {
          <span>Incorrect. The correct answer was: {{ currentQuestion.options[currentQuestion.correctAnswer] }}</span>
        }
      </div>
      <button class="next-button" (click)="nextQuestion()">
        {{ currentIndex < questions.length - 1 ? 'Next Question' : 'See Results' }}
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      </button>
    </div>
    }
  </div>
</div>
}

<!-- Results Mode -->
@if (mode === 'results' && result) {
<div class="quiz-container">
  <div class="results-card">
    <div class="results-header" [class]="getScoreClass()">
      <div class="score-circle">
        <span class="score-value">{{ result.score }}%</span>
      </div>
      <h2>Quiz Complete!</h2>
      @if (result.score >= 80) {
        <p class="score-message">Excellent work!</p>
      } @else if (result.score >= 60) {
        <p class="score-message">Good job!</p>
      } @else if (result.score >= 40) {
        <p class="score-message">Keep practicing!</p>
      } @else {
        <p class="score-message">More review needed</p>
      }
    </div>

    <div class="results-stats">
      <div class="stat">
        <span class="stat-value correct">{{ result.correctAnswers }}</span>
        <span class="stat-label">Correct</span>
      </div>
      <div class="stat">
        <span class="stat-value incorrect">{{ result.incorrectAnswers }}</span>
        <span class="stat-label">Incorrect</span>
      </div>
      <div class="stat">
        <span class="stat-value">{{ result.totalQuestions }}</span>
        <span class="stat-label">Total</span>
      </div>
    </div>

    <div class="results-actions">
      <button class="restart-button" (click)="restartQuiz()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
        </svg>
        Take Another Quiz
      </button>
    </div>

    <!-- Review Section -->
    <div class="review-section">
      <h3>Review Your Answers</h3>
      <div class="review-list">
        @for (q of result.questions; track q.knowledgeUnit.id) {
        <div class="review-item" [class.correct]="q.isCorrect" [class.incorrect]="!q.isCorrect">
          <div class="review-number">{{ $index + 1 }}</div>
          <div class="review-content">
            <div class="review-concept">{{ q.knowledgeUnit.concept }}</div>
            <div class="review-question">{{ q.questionText }}</div>
            <div class="review-answer">
              @if (q.isCorrect) {
              <span class="answer-correct">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
                {{ q.options[q.correctAnswer] }}
              </span>
              } @else {
              <span class="answer-incorrect">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Your answer: {{ q.options[q.selectedAnswer!] }}
                <br />
                <span class="correct-answer">Correct: {{ q.options[q.correctAnswer] }}</span>
              </span>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>
}