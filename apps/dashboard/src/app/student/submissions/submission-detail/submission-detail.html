<div class="detail-container">
  <div class="detail-header">
    <h1 class="detail-title">{{ originalTitle() | titlecase }}</h1>
    @if (submission?.id) {
      <div class="submission-info">
        <span class="status-indicator" [style.background-color]="getStatusColor(submission?.status || 'draft')">
          {{ formatStatus(submission?.status || 'draft') | titlecase }}
        </span>
        @if (submission?.score !== undefined && submission?.score !== null) {
          <span class="score-indicator">Score: {{ submission?.score }}%</span>
        }
      </div>
    }
  </div>

  <form (submit)="onSubmit($event)" class="detail-form">
    <div class="detail-content">
      <!-- Title -->
      <div class="detail-section">
        <label class="detail-section-title">Title *</label>
        <input
          type="text"
          class="detail-input"
          placeholder="Submission title"
          [value]="title()"
          (input)="title.set($any($event.target).value)"
        />
      </div>

      <!-- Challenge / Project Selector -->
      <div class="detail-section">
        <label class="detail-section-title">Submit For</label>
        <p class="section-help">Optionally link this submission to a challenge or project</p>
        <div class="selector-row">
          <div class="selector-group">
            <label class="selector-label">Challenge</label>
            <select
              class="detail-select"
              [value]="challengeId() || ''"
              (change)="onChallengeChange($any($event.target).value)"
            >
              <option value="">None</option>
              @for (challenge of challenges(); track challenge.id) {
                <option [value]="challenge.id">{{ challenge.title }}</option>
              }
            </select>
          </div>
          <span class="selector-divider">or</span>
          <div class="selector-group">
            <label class="selector-label">Project</label>
            <select
              class="detail-select"
              [value]="projectId() || ''"
              (change)="onProjectChange($any($event.target).value)"
            >
              <option value="">None</option>
              @for (project of projects(); track project.id) {
                <option [value]="project.id">{{ project.name }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <!-- Content Type Selector -->
      <div class="detail-section">
        <label class="detail-section-title">Content Type *</label>
        <div class="content-type-selector">
          <button
            type="button"
            class="type-button"
            [class.active]="contentType() === 'text'"
            (click)="onContentTypeChange('text')"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="type-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
            </svg>
            Text / Code
          </button>
          <button
            type="button"
            class="type-button"
            [class.active]="contentType() === 'url'"
            (click)="onContentTypeChange('url')"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="type-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
            </svg>
            URL Link
          </button>
          <button
            type="button"
            class="type-button"
            [class.active]="contentType() === 'file'"
            (click)="onContentTypeChange('file')"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="type-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
            </svg>
            File Upload
          </button>
        </div>
      </div>

      <!-- Text/Code Content -->
      @if (contentType() === 'text') {
        <div class="detail-section">
          <label class="detail-section-title">Content *</label>
          <textarea
            class="detail-textarea"
            placeholder="Enter your code or text content..."
            rows="15"
            [value]="content()"
            (input)="content.set($any($event.target).value)"
          ></textarea>
        </div>
      }

      <!-- URL Input -->
      @if (contentType() === 'url') {
        <div class="detail-section">
          <label class="detail-section-title">URL *</label>
          <div class="url-input-row">
            <input
              type="url"
              class="detail-input url-input"
              placeholder="https://github.com/username/repo"
              [value]="url()"
              (input)="url.set($any($event.target).value)"
            />
            <button
              type="button"
              class="fetch-button"
              (click)="fetchMetadata()"
              [disabled]="isFetchingMetadata()"
            >
              @if (isFetchingMetadata()) {
                <span class="loading-spinner"></span>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="fetch-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
              }
              Fetch Metadata
            </button>
          </div>

          <!-- URL Metadata Display -->
          @if (urlMetadata()) {
            <div class="url-metadata">
              <div class="metadata-header">
                <span class="platform-badge">{{ urlMetadata()?.platform || 'link' }}</span>
                @if (urlMetadata()?.title) {
                  <span class="metadata-title">{{ urlMetadata()?.title }}</span>
                }
              </div>
              @if (urlMetadata()?.description) {
                <p class="metadata-description">{{ urlMetadata()?.description }}</p>
              }
              @if (urlMetadata()?.repoStats) {
                <div class="repo-stats">
                  @if (urlMetadata()?.repoStats?.stars !== undefined) {
                    <span class="stat-item">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="stat-icon">
                        <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd" />
                      </svg>
                      {{ urlMetadata()?.repoStats?.stars }}
                    </span>
                  }
                  @if (urlMetadata()?.repoStats?.language) {
                    <span class="stat-item language">{{ urlMetadata()?.repoStats?.language }}</span>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- File Upload -->
      @if (contentType() === 'file') {
        <div class="detail-section">
          <label class="detail-section-title">File *</label>

          @if (!selectedFile() && !(submission?.contentType === 'file' && submission?.content)) {
            <div
              class="file-dropzone"
              (drop)="onFileDrop($event)"
              (dragover)="onDragOver($event)"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="dropzone-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
              </svg>
              <p class="dropzone-text">Drag and drop a file here, or click to browse</p>
              <p class="dropzone-hint">Supports PDF, images, code files, and ZIP archives (max 10MB)</p>
              <input
                type="file"
                class="file-input"
                (change)="onFileSelected($event)"
                accept=".pdf,.doc,.docx,.txt,.md,.png,.jpg,.jpeg,.gif,.webp,.py,.js,.ts,.jsx,.tsx,.html,.css,.json,.java,.c,.cpp,.zip"
              />
            </div>
          } @else {
            <div class="file-preview">
              <div class="file-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="file-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                <div class="file-details">
                  <span class="file-name">{{ selectedFile()?.name || submission?.fileMetadata?.originalName || 'Uploaded file' }}</span>
                  @if (selectedFile()) {
                    <span class="file-size">{{ formatFileSize(selectedFile()!.size) }}</span>
                  } @else if (submission?.fileMetadata?.size) {
                    <span class="file-size">{{ formatFileSize(submission!.fileMetadata!.size!) }}</span>
                  }
                </div>
              </div>
              @if (selectedFile()) {
                <button type="button" class="remove-file" (click)="removeFile()">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                  </svg>
                </button>
              }
            </div>
          }
        </div>
      }
    </div>

    <div class="detail-actions">
      <button
        type="button"
        class="detail-button detail-button-secondary"
        (click)="onCancel()"
      >
        Cancel
      </button>

      @if (canSubmitForReview()) {
        <button
          type="button"
          class="detail-button detail-button-submit"
          (click)="onSubmitForReview()"
        >
          Submit for Review
        </button>
      }

      @if (canRequestFeedback()) {
        <button
          type="button"
          class="detail-button detail-button-feedback"
          (click)="onRequestFeedback()"
        >
          Request AI Feedback
        </button>
      }

      <button
        type="submit"
        class="detail-button detail-button-primary"
        [disabled]="!isFormValid()"
      >
        {{ submission?.id ? 'Update' : 'Create' }}
      </button>
    </div>
  </form>
</div>
